syntax = "proto3";

package qubic.v2.archive.pb;
option go_package = "github.com/qubic/archive-query-service/api";
import "openapiv3/annotations.proto";

message LastProcessedTick {
  uint32 tick_number = 1;
}

message NextAvailableTick {
  uint32 next_tick_number = 1;
}

// Transaction
message Transaction {
  string hash = 1;
  uint64 amount = 2;
  string source = 3;
  string destination = 4;
  uint32 tick_number = 5;
  uint64 timestamp = 6;
  uint32 input_type = 7 [(openapi.v3.property) = {description: "Smart contract procedure index. (The smart contract procedure this transaction is supposed to trigger)"}];
  uint32 input_size = 8 [(openapi.v3.property) = {description: "Size of input_data byte array."}];
  string input_data = 9 [(openapi.v3.property) = {description: "Base64 encoded byte array containing a smart contract payload."}];
  string signature = 10 [(openapi.v3.property) = {description: "Base64 encoded byte array representing the transactions's signature."}];
  bool money_flew = 11 [(openapi.v3.property) = {description: "Money flew is an additional information provided by some nodes with the tx status addon patch."}];
}

// TickData
message TickData {
  uint32 tick_number = 1;
  uint32 epoch = 2;
  uint32 computor_index = 3;
  uint64 timestamp = 4;
  string var_struct = 5;
  string time_lock = 6;
  repeated string transaction_hashes = 7;
  repeated int64 contract_fees = 8;
  string signature = 9;
}

// ProcessedTickInterval
message ProcessedTickInterval {
  uint32 epoch = 1 [(openapi.v3.property) = {description:"The epoch the interval is in."}];
  uint32 first_tick = 2 [(openapi.v3.property) = {description:"The initial processed tick of the interval."}];
  uint32 last_tick = 3 [(openapi.v3.property) = {description:"The last processed tick of the interval."}];
}

// Pagination
message Pagination {
  option (openapi.v3.schema) = {
    description: "The number of maximum results (offset + size) is limited to 10000."
  };
  uint32 offset = 1 [(openapi.v3.property) = {description:"The offset specifies the starting point of the returned data. Defaults to zero."}];
  uint32 size = 2 [(openapi.v3.property) = {description:"The size specifies how many results should be returned. Defaults to 10."}];
}

// GetTransactionByHashRequest
message GetTransactionByHashRequest {
  string hash = 1 [(openapi.v3.property) = {description:"The hash of the transaction."}];
}

// GetTransactionByHashResponse
message GetTransactionByHashResponse {
  Transaction transaction = 1 [(openapi.v3.property) = {description:"The transaction for the requested hash."}];
}

// GetTransactionsForTickRequest
message GetTransactionsForTickRequest {
  option (openapi.v3.schema) = {
    example: {
      yaml: "tickNumber: 42977140\nfilters:\n  destination: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFXIB\nranges:\n  amount:\n    gte: \"1\""
    };
  };
  // the tick number to get the transactions for.
  uint32 tick_number = 1 [(openapi.v3.property) = {description:"The tick number to get the transactions for."}];
  map<string, string> filters = 2 [(openapi.v3.property) = {description:"Filters restrict the results by single values. Allowed: source, destination, amount, inputType"}];
  map<string, Range> ranges = 3 [(openapi.v3.property) = {description:"Ranges restrict the results by a maximum and minimum value. Allowed: amount, inputType"}];
}

// GetTransactionsForTickResponse
message GetTransactionsForTickResponse {
  repeated Transaction transactions = 1 [(openapi.v3.property) = {description:"The transactions for the requested tick number."}];
}

// Range
message Range {
  oneof lower_bound {
    string gt = 1 [(openapi.v3.property) = {description:"Greater than."}];
    string gte = 2 [(openapi.v3.property) = {description:"Greater than or equal."}];
  }
  oneof upper_bound {
    string lt = 3 [(openapi.v3.property) = {description:"Less than."}];
    string lte = 4 [(openapi.v3.property) = {description:"Less than or equal."}];
  }
}

// GetTransactionsForIdentityRequest
message GetTransactionsForIdentityRequest {
  option (openapi.v3.schema) = {
    example: {
      yaml: "identity: AFZPUAIYVPNUYGJRQVLUKOPPVLHAZQTGLYAAUUNBXFTVTAMSBKQBLEIEPCVJ\nfilters:\n  destination: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFXIB\n  inputType: \"0\"\nranges:\n  amount:\n    gte: \"1000000000\"\npagination:\n  offset: 0\n  size: 10"
    };
  };

  string identity = 1 [(openapi.v3.property) = {description:"The identity to get the transactions for. Incoming and outgoing transactions are queried by default."}];
  map<string, string> filters = 2 [(openapi.v3.property) = {description:"Filters restrict the results by single values."}];
  map<string, Range> ranges = 3 [(openapi.v3.property) = {description:"Ranges restrict the results by a maximum and minimum value."}];
  Pagination pagination = 4 [(openapi.v3.property) = {description:"Optional paging information ."}];
}

// Hits
message Hits {
  option (openapi.v3.schema) = {
    description: "Provides information about the number of results."
  };

  uint32 total = 1 [(openapi.v3.property) = {description:"The total number of hits available in the archive. Capped at 10000."}];
  uint32 from = 2 [(openapi.v3.property) = {description:"Starting offset of the hits that were returned."}];
  uint32 size = 3 [(openapi.v3.property) = {description:"Number of returned hits."}];
}

// GetTransactionsForIdentityResponse
message GetTransactionsForIdentityResponse {
  uint32 valid_for_tick = 1 [(openapi.v3.property) = {description:"The response is valid for this tick number."}];
  Hits hits = 2 [(openapi.v3.property) = {description:"Information about the returned results."}];
  repeated Transaction transactions = 3 [(openapi.v3.property) = {description:"List of transactions that matched the search criteria."}];
}

// GetTickDataRequest
message GetTickDataRequest {
  uint32 tick_number = 1 [(openapi.v3.property) = {description:"The number of tick the tick data is requested for."}];
}

// GetTickDataResponse
message GetTickDataResponse {
  TickData tick_data = 1 [(openapi.v3.property) = {description:"The tick data of the requested tick."}];
}

// GetProcessedTickIntervalsResponse
message GetProcessedTickIntervalsResponse {
  repeated ProcessedTickInterval processed_tick_intervals = 1 [(openapi.v3.property) = {description:"A list of tick intervals that were processed."}];
}

// GetLastProcessedTickResponse
message GetLastProcessedTickResponse {
  uint32 tick_number = 1 [(openapi.v3.property) = {description:"The last processed tick that is available in the archive."}];
  uint32 epoch = 2 [(openapi.v3.property) = {description:"The epoch the last processed tick is in."}];
  uint32 interval_initial_tick = 3 [(openapi.v3.property) = {description:"The initial tick of the current tick interval."}];
}

// GetComputorListsForEpochRequest
message GetComputorListsForEpochRequest {
  uint32 epoch = 1 [(openapi.v3.property) = {description:"The epoch number to get the computor lists for."}];
}

// ComputorList
message ComputorList {
  uint32 epoch = 1 [(openapi.v3.property) = {description:"Epoch number."}];
  uint32 tick_number = 2 [(openapi.v3.property) = {description:"Tick number when the list was received by the archive after it was published."}];
  repeated string identities = 3 [(openapi.v3.property) = {description:"List of computor identities (signed by arbitrator)."}];
  string signature = 4 [(openapi.v3.property) = {description:"Signature of the arbitrator."}];
}

// GetComputorListsForEpochResponse
message GetComputorListsForEpochResponse {
  repeated ComputorList computors_lists = 1 [(openapi.v3.property) = {description:"The lists of computors that voted in this epoch."}];
}

// HealthResponse
message HealthResponse {
  string status = 1 [(openapi.v3.property) = {description:"Health status information."}];
}

// QuTransferData contains fields specific to QU transfer events (type 0).
message QuTransferData {
  string source = 1;
  string destination = 2;
  uint64 amount = 3;
}

// AssetIssuanceData contains fields specific to asset issuance events (type 1).
message AssetIssuanceData {
  string asset_issuer = 1;
  uint64 number_of_shares = 2;
  uint64 managing_contract_index = 3;
  string asset_name = 4;
  uint32 number_of_decimal_places = 5;
  string unit_of_measurement = 6;
}

// AssetOwnershipChangeData contains fields specific to asset ownership change events (type 2).
message AssetOwnershipChangeData {
  string source = 1;
  string destination = 2;
  string asset_issuer = 3;
  string asset_name = 4;
  uint64 number_of_shares = 5;
}

// AssetPossessionChangeData contains fields specific to asset possession change events (type 3).
message AssetPossessionChangeData {
  string source = 1;
  string destination = 2;
  string asset_issuer = 3;
  string asset_name = 4;
  uint64 number_of_shares = 5;
}

// BurningData contains fields specific to burning events (type 8).
message BurningData {
  string source = 1;
  uint64 amount = 2;
  uint64 contract_index_burned_for = 3;
}

// ContractReserveDeductionData contains fields specific to contract reserve deduction events (type 13).
message ContractReserveDeductionData {
  uint64 deducted_amount = 1;
  int64 remaining_amount = 2;
  uint64 contract_index = 3;
}

// Event
message Event {
  uint32 epoch = 1;
  uint32 tick_number = 2;
  uint64 timestamp = 3;
  uint64 emitting_contract_index = 4;
  string transaction_hash = 5;
  uint64 log_id = 6;
  string log_digest = 7;
  uint32 event_type = 8;
  uint32 category = 9;
  oneof event_data {
    QuTransferData qu_transfer = 10;
    AssetIssuanceData asset_issuance = 11;
    AssetOwnershipChangeData asset_ownership_change = 12;
    AssetPossessionChangeData asset_possession_change = 13;
    BurningData burning = 14;
    ContractReserveDeductionData contract_reserve_deduction = 15;
  }
}

// GetEventsRequest
message GetEventsRequest {
  option (openapi.v3.schema) = {
    example: {
      yaml: "filters:\n  transactionHash: zvqvtjzvgwgpegmalkkjedhbdrnckqcfthpzfqzxbcljttljzidmvaxalxyz\npagination:\n  offset: 0\n  size: 10"
    };
  };
  map<string, string> filters = 1 [(openapi.v3.property) = {description:"Filters restrict the results by single values. Allowed: transactionHash, tickNumber, eventType"}];
  Pagination pagination = 2 [(openapi.v3.property) = {description:"Optional paging information."}];
}

// GetEventsResponse
message GetEventsResponse {
  Hits hits = 1 [(openapi.v3.property) = {description:"Information about the returned results."}];
  repeated Event events = 2 [(openapi.v3.property) = {description:"List of events that matched the search criteria."}];
}